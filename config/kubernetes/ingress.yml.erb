---
# Configure the ingress point for HTTPS traffic into the web
# application.
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: soundstorm-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
    - hosts:
        - <%= Rails.configuration.asset_host.gsub('https://', '') %>
        - <%= Rails.configuration.host %>
        - logs.<%= Rails.configuration.host %>
      secretName: soundstorm-tls
  rules:
    # Main web application
    - host: <%= Rails.configuration.host %>
      http:
        paths:
          - backend:
              serviceName: web
              servicePort: 3000
            path: /
    # CDN for media and static assets
    - host: <%= Rails.configuration.asset_host.gsub('https://', '') %>
      http:
        paths:
          - backend:
              serviceName: web
              servicePort: 3000
            path: /
    # Log viewer
    - host: logs.<%= Rails.configuration.host %>
      http:
        paths:
          - backend:
              serviceName: kibana
              servicePort: 5601
            path: /
